!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("shared-reducer-frontend",[],e):"object"==typeof exports?exports["shared-reducer-frontend"]=e():t["shared-reducer-frontend"]=e()}(global,(function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var s=e[i]={i:i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(i,s,function(e){return t[e]}.bind(null,s));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=1)}([function(t,e){t.exports=require("json-immutability-helper")},function(t,e,n){t.exports=n(2)},function(t,e,n){"use strict";function i(t){return t?e=>(t(e),null):null}function s(t){if(!t)return null;const e=e=>t(e);return e.afterSync=!0,e}n.r(e),n.d(e,"actionsHandledCallback",(function(){return i})),n.d(e,"actionsSyncedCallback",(function(){return s}));var r=n(0);function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}class l{constructor(t,e,n,i){this.messageCallback=n,this.errorCallback=i,a(this,"ws",void 0),a(this,"pingTimeout",null),a(this,"sendPing",()=>{this.ws.send("P")}),a(this,"handleMessage",({data:t})=>{this.queueNextPing(),"p"!==t&&this.messageCallback(JSON.parse(t))}),a(this,"handleError",()=>{var t;null===(t=this.errorCallback)||void 0===t||t.call(this,"Failed to connect")}),a(this,"handleClose",()=>{null!==this.pingTimeout&&clearTimeout(this.pingTimeout)}),this.ws=new WebSocket(t),this.ws.addEventListener("message",this.handleMessage),this.ws.addEventListener("error",this.handleError),this.ws.addEventListener("close",this.handleClose),e&&this.ws.addEventListener("open",()=>this.ws.send(e),{once:!0}),this.queueNextPing()}send(t){this.ws.send(JSON.stringify(t))}close(){this.ws.close(),null!==this.pingTimeout&&clearTimeout(this.pingTimeout)}queueNextPing(){null!==this.pingTimeout&&clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(this.sendPing,2e4)}}function c(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}e.default=class{constructor(t,e,n,i,s){this.changeCallback=n,this.warningCallback=s,c(this,"connection",void 0),c(this,"latestServerState",void 0),c(this,"latestLocalState",void 0),c(this,"currentChange",void 0),c(this,"currentSyncCallbacks",[]),c(this,"localChanges",[]),c(this,"syncCallbacks",new Map),c(this,"pendingChanges",[]),c(this,"isDispatching",!1),c(this,"idCounter",0),c(this,"dispatch",t=>{if(!t||!t.length)return;if(this.isDispatching)throw new Error("Cannot dispatch recursively");const e=this.getState();if(void 0===e)this.pendingChanges.push(...t);else{const i=this.internalApply(e,t);var n;if(i!==e)null===(n=this.changeCallback)||void 0===n||n.call(this,i)}}),c(this,"internalSend",()=>{if(void 0===this.currentChange)return;const t={change:this.currentChange,id:this.internalGetUniqueId()};this.localChanges.push(t),this.currentSyncCallbacks.length>0&&(this.syncCallbacks.set(t.id,this.currentSyncCallbacks),this.currentSyncCallbacks=[]),this.connection.send(t),this.currentChange=void 0}),c(this,"handleMessage",t=>{const e=t,n=void 0===e.id?-1:this.localChanges.findIndex(t=>t.id===e.id);-1!==n&&this.localChanges.splice(n,1);let i=!0;var s;void 0!==e.error?null===(s=this.warningCallback)||void 0===s||s.call(this,"Update failed: "+e.error):(0===n&&(i=!1),this.latestServerState=Object(r.update)(this.latestServerState||{},e.change));i&&(this.latestLocalState=void 0);let a=this.getState();if(this.pendingChanges.length&&void 0!==a){const t=this.internalApply(a,this.pendingChanges);t!==a&&(a=t,i=!0),this.pendingChanges.length=0}var l;i&&void 0!==a&&(null===(l=this.changeCallback)||void 0===l||l.call(this,a));if(void 0!==e.id){const t=this.syncCallbacks.get(e.id);if(t){this.syncCallbacks.delete(e.id);const n=a;if(void 0===n)throw new Error("Did not receive initial state from server");t.forEach(t=>t(n))}}}),this.connection=new l(t,e,this.handleMessage,i)}close(){this.connection.close(),this.latestServerState=void 0,this.latestLocalState=void 0,this.currentChange=void 0,this.currentSyncCallbacks=[],this.localChanges=[],this.syncCallbacks.clear(),this.pendingChanges=[]}addSyncCallback(t){this.dispatch([s(t)])}getState(){return!this.latestLocalState&&this.latestServerState&&(this.latestLocalState=this.internalLocalStateFromServerState(this.latestServerState)),this.latestLocalState}internalLocalStateFromServerState(t){let e=Object(r.update)(t,Object(r.combine)(this.localChanges.map(({change:t})=>t)));return this.currentChange&&(e=Object(r.update)(e,this.currentChange)),e}internalGetUniqueId(){return this.idCounter+=1,this.idCounter}internalApply(t,e){this.isDispatching=!0;const{state:n,delta:i}=function(t,e,n){let i=t;const s=[],a=[];function l(){if(a.length>0){const t=Object(r.combine)(a);s.push(t),i=Object(r.update)(i,t),a.length=0}}return function(t,e){let n={vs:t,i:0,prev:null};for(;n;)if(n.i>=n.vs.length)n=n.prev;else{const t=e(n.vs[n.i]);n.i+=1,t&&t.length&&(n={vs:t,i:0,prev:n})}}(e,e=>"function"==typeof e?(l(),e.afterSync?(n(e,i),null):e(t)):(e&&a.push(e),null)),l(),{state:i,delta:Object(r.combine)(s)}}(t,e,(e,n)=>{n!==t||this.currentChange?this.currentSyncCallbacks.push(e):e(t)});return this.isDispatching=!1,n!==t&&(this.latestLocalState=n,this.currentChange?this.currentChange=Object(r.combine)([this.currentChange,i]):(this.currentChange=i,setTimeout(this.internalSend,0))),n}}}])}));
//# sourceMappingURL=index.js.map