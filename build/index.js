!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("shared-reducer-frontend",[],e):"object"==typeof exports?exports["shared-reducer-frontend"]=e():t["shared-reducer-frontend"]=e()}(global,(function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var s=e[i]={i:i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(i,s,function(e){return t[e]}.bind(null,s));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=1)}([function(t,e){t.exports=require("json-immutability-helper")},function(t,e,n){t.exports=n(2)},function(t,e,n){"use strict";function i(t){return t?e=>(t(e),null):null}function s(t,e){if(!t&&!e)return null;const n=e=>null==t?void 0:t(e);return n.reject=e,n.afterSync=!0,n}n.r(e),n.d(e,"actionsHandledCallback",(function(){return i})),n.d(e,"actionsSyncedCallback",(function(){return s}));var a=n(0);function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}class l{constructor(t,e,n,i){this.messageCallback=n,this.errorCallback=i,r(this,"ws",void 0),r(this,"pingTimeout",null),r(this,"sendPing",()=>{this.ws.send("P")}),r(this,"handleMessage",({data:t})=>{this.queueNextPing(),"p"!==t&&this.messageCallback(JSON.parse(t))}),r(this,"handleError",()=>{var t;null===(t=this.errorCallback)||void 0===t||t.call(this,"Failed to connect")}),r(this,"handleClose",()=>{null!==this.pingTimeout&&clearTimeout(this.pingTimeout)}),this.ws=new WebSocket(t),this.ws.addEventListener("message",this.handleMessage),this.ws.addEventListener("error",this.handleError),this.ws.addEventListener("close",this.handleClose),e&&this.ws.addEventListener("open",()=>this.ws.send(e),{once:!0}),this.queueNextPing()}send(t){this.ws.send(JSON.stringify(t))}close(){this.ws.close(),null!==this.pingTimeout&&clearTimeout(this.pingTimeout)}queueNextPing(){null!==this.pingTimeout&&clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(this.sendPing,2e4)}}function c(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}e.default=class{constructor(t,e,n,i,s){this.changeCallback=n,this.warningCallback=s,c(this,"connection",void 0),c(this,"latestServerState",void 0),c(this,"latestLocalState",void 0),c(this,"currentChange",void 0),c(this,"currentSyncCallbacks",[]),c(this,"localChanges",[]),c(this,"pendingChanges",[]),c(this,"dispatchLock",(t=>{let e=!1;return n=>{if(e)throw new Error(t);try{return e=!0,n()}finally{e=!1}}})("Cannot dispatch recursively")),c(this,"nextId",(()=>{let t=0;return()=>(t+=1,t)})()),c(this,"dispatch",t=>{if(!t||!t.length)return;const e=this.getState();void 0===e?this.pendingChanges.push(...t):this.applySpecs(e,t,!1)}),c(this,"sendCurrentChange",()=>{if(!this.currentChange)return;const t=this.nextId(),e=this.currentChange,n=this.currentSyncCallbacks;this.currentChange=void 0,this.currentSyncCallbacks=[],this.localChanges.push({change:e,id:t,syncCallbacks:n}),this.connection.send({change:e,id:t})}),c(this,"handleMessage",t=>{const e=t,{localChange:n,index:i}=this.popLocalChange(e.id);if(void 0!==e.error){var s;null===(s=this.warningCallback)||void 0===s||s.call(this,"Update failed: "+e.error),this.latestLocalState=void 0;const t=this.getState();var r;if(t)null===(r=this.changeCallback)||void 0===r||r.call(this,t);return void(null==n||n.syncCallbacks.forEach(t=>{var n;return null===(n=t.reject)||void 0===n?void 0:n.call(t,e.error)}))}const l=0!==i;this.latestServerState=Object(a.update)(this.latestServerState||{},e.change),this.latestLocalState&&!l||(this.latestLocalState=this.localStateFromServerState(this.latestServerState));let c=this.latestLocalState;c=this.applySpecs(c,this.pendingChanges,l),this.pendingChanges.length=0,null==n||n.syncCallbacks.forEach(t=>t(c))}),this.connection=new l(t,e,this.handleMessage,i)}close(){this.connection.close(),this.latestServerState=void 0,this.latestLocalState=void 0,this.currentChange=void 0,this.currentSyncCallbacks=[],this.localChanges=[],this.pendingChanges=[]}addSyncCallback(t,e){this.dispatch([s(t,e)])}syncedState(){return new Promise((t,e)=>{this.addSyncCallback(t,e)})}getState(){return!this.latestLocalState&&this.latestServerState&&(this.latestLocalState=this.localStateFromServerState(this.latestServerState)),this.latestLocalState}localStateFromServerState(t){let e=Object(a.update)(t,Object(a.combine)(this.localChanges.map(({change:t})=>t)));return this.currentChange&&(e=Object(a.update)(e,this.currentChange)),e}addCurrentChange(t){this.currentChange?this.currentChange=Object(a.combine)([this.currentChange,t]):(this.currentChange=t,setTimeout(this.sendCurrentChange,0))}applySpecs(t,e,n){if(!e.length){var i;if(n)null===(i=this.changeCallback)||void 0===i||i.call(this,t);return t}const{state:s,delta:r}=this.dispatchLock(()=>function(t,e,n){let i=t;const s=[],r=[];function l(){if(r.length>0){const t=Object(a.combine)(r);s.push(t),i=Object(a.update)(i,t),r.length=0}}return function(t,e){let n={vs:t,i:0,prev:null};for(;n;)if(n.i>=n.vs.length)n=n.prev;else{const t=e(n.vs[n.i]);n.i+=1,t&&t.length&&(n={vs:t,i:0,prev:n})}}(e,t=>"function"==typeof t?(l(),t.afterSync?(n(t,i),null):t(i)):(t&&r.push(t),null)),l(),{state:i,delta:Object(a.combine)(s)}}(t,e,(e,n)=>{n!==t||this.currentChange?this.currentSyncCallbacks.push(e):e(t)}));var l;(s!==t&&(this.latestLocalState=s,this.addCurrentChange(r)),s!==t||n)&&(null===(l=this.changeCallback)||void 0===l||l.call(this,s));return s}popLocalChange(t){const e=void 0===t?-1:this.localChanges.findIndex(e=>e.id===t);return-1===e?{localChange:null,index:e}:{localChange:this.localChanges.splice(e,1)[0],index:e}}}}])}));
//# sourceMappingURL=index.js.map